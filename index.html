<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat & Share | Real-Time Chat with Location Sharing</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        /* ===== CSS VARIABLES ===== */
        :root {
            --primary: #6e8efb;
            --secondary: #a777e3;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --white: #ffffff;
            --bg-gradient: linear-gradient(135deg, #6e8efb, #a777e3);
            --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        /* ===== BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--bg-gradient);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--dark);
            line-height: 1.6;
        }

        /* ===== AUTH SCREENS ===== */
        .auth-container {
            background: var(--white);
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            width: 100%;
            max-width: 450px;
            padding: 30px;
            transition: var(--transition);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .auth-header h2 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .auth-form .form-group {
            margin-bottom: 20px;
        }

        .auth-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .auth-form input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
        }

        .auth-form input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(110, 142, 251, 0.2);
        }

        .auth-form button {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .auth-form button:hover {
            background: #5a7df9;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
        }

        .auth-switch a {
            color: var(--primary);
            text-decoration: none;
            cursor: pointer;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        /* ===== MAIN APP ===== */
        .container {
            width: 100%;
            max-width: 1200px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 95vh;
            display: none;
        }

        header, footer {
            padding: 20px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: var(--white);
            text-align: center;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 280px;
            background: var(--light);
            padding: 20px;
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        .user-profile {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 22px;
            font-weight: bold;
            margin-right: 12px;
        }

        .user-info {
            flex: 1;
        }

        .username {
            font-weight: bold;
            font-size: 17px;
            margin-bottom: 4px;
        }

        .status {
            font-size: 13px;
            color: var(--success);
            display: flex;
            align-items: center;
        }

        .status::before {
            content: "";
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            margin-right: 6px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--dark);
            text-decoration: none;
        }

        .nav-item.active {
            background: var(--primary);
            color: var(--white);
        }

        .nav-item:hover:not(.active) {
            background: rgba(110, 142, 251, 0.1);
        }

        .nav-item i {
            margin-right: 12px;
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        /* ===== CHAT CONTAINER ===== */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            padding: 18px 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--white);
        }

        .chat-title {
            font-size: 20px;
            font-weight: bold;
        }

        .online-users {
            display: flex;
            align-items: center;
        }

        .online-count {
            background: rgba(0, 0, 0, 0.1);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 14px;
            margin-right: 10px;
        }

        .chat-actions button {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            transition: var(--transition);
        }

        .chat-actions button:hover {
            background: #5a7df9;
            transform: translateY(-2px);
        }

        .chat-actions button i {
            margin-right: 6px;
        }

        /* ===== MESSAGES ===== */
        .messages {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background: rgba(248, 249, 250, 0.5);
        }

        .message {
            max-width: 75%;
            padding: 14px 18px;
            border-radius: 18px;
            margin-bottom: 18px;
            position: relative;
            animation: fadeIn 0.4s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.incoming {
            background: var(--white);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .message.outgoing {
            background: var(--primary);
            color: var(--white);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
            box-shadow: 0 4px 12px rgba(110, 142, 251, 0.3);
        }

        .message-sender {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 6px;
        }

        .message-text {
            word-wrap: break-word;
        }

        .message-time {
            font-size: 12px;
            opacity: 0.8;
            text-align: right;
            margin-top: 6px;
        }

        .location-message {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 18px;
            padding: 16px;
            margin-bottom: 18px;
            max-width: 75%;
            align-self: flex-start;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .location-title {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            color: var(--info);
        }

        .location-title i {
            margin-right: 8px;
        }

        .map-preview {
            height: 180px;
            background: #ddd;
            border-radius: 12px;
            margin: 12px 0;
            overflow: hidden;
            position: relative;
        }

        .map-preview .leaflet-container {
            border-radius: 12px;
            height: 100%;
            width: 100%;
        }

        .location-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .location-actions button {
            background: var(--info);
            color: var(--white);
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
        }

        .location-actions button:hover {
            background: #138496;
        }

        /* ===== INPUT AREA ===== */
        .input-area {
            padding: 18px 24px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            background: var(--white);
            position: relative;
        }

        .message-input {
            flex: 1;
            padding: 14px 18px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 24px;
            outline: none;
            font-size: 16px;
            transition: var(--transition);
            padding-right: 45px;
        }

        .message-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(110, 142, 251, 0.2);
        }

        .emoji-trigger {
            position: absolute;
            right: 145px;
            background: none;
            border: none;
            font-size: 20px;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
        }

        .emoji-trigger:hover {
            color: var(--primary);
        }

        .emoji-picker {
            position: absolute;
            bottom: 80px;
            right: 24px;
            width: 300px;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 15px;
            z-index: 100;
            display: none;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
        }

        .emoji-picker.active {
            display: grid;
        }

        .emoji-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: var(--transition);
        }

        .emoji-btn:hover {
            background: var(--light);
        }

        .action-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-left: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: var(--transition);
            border: none;
            color: var(--white);
        }

        .action-button:hover {
            transform: scale(1.08);
        }

        .emoji-button {
            background: var(--warning);
        }

        .emoji-button:hover {
            background: #e0a800;
        }

        .location-button {
            background: var(--success);
        }

        .location-button:hover {
            background: #218838;
        }

        .send-button {
            background: var(--primary);
        }

        .send-button:hover {
            background: #5a7df9;
        }

        /* ===== FOOTER ===== */
        footer {
            font-size: 14px;
            padding: 16px;
        }

        /* ===== RESPONSIVE STYLES ===== */
        @media (max-width: 992px) {
            .sidebar {
                width: 230px;
            }
            
            .message {
                max-width: 85%;
            }
        }

        @media (max-width: 768px) {
            .container {
                height: 100vh;
                border-radius: 0;
            }
            
            body {
                padding: 0;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid rgba(0, 0, 0, 0.1);
                padding: 15px;
                max-height: 180px;
                overflow-y: auto;
            }
            
            .user-profile {
                margin-bottom: 15px;
            }
            
            .nav-items {
                display: flex;
                overflow-x: auto;
                padding-bottom: 5px;
                gap: 8px;
            }
            
            .nav-item {
                flex-shrink: 0;
                margin-bottom: 0;
            }
            
            .message {
                max-width: 90%;
            }
            
            .map-preview {
                height: 150px;
            }
            
            .emoji-picker {
                width: 250px;
                right: 15px;
                grid-template-columns: repeat(6, 1fr);
            }
        }

        @media (max-width: 576px) {
            .chat-header {
                padding: 14px 16px;
            }
            
            .messages {
                padding: 16px;
            }
            
            .input-area {
                padding: 14px 16px;
            }
            
            .action-button {
                width: 45px;
                height: 45px;
            }
            
            .location-message {
                max-width: 90%;
            }
            
            .chat-actions button {
                padding: 8px 14px;
                font-size: 13px;
            }
            
            .emoji-trigger {
                right: 130px;
            }
            
            .emoji-picker {
                width: 220px;
                grid-template-columns: repeat(5, 1fr);
            }
        }

        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-1 {
            margin-top: 8px;
        }

        .mt-2 {
            margin-top: 16px;
        }

        .mb-1 {
            margin-bottom: 8px;
        }

        .mb-2 {
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="auth-container" id="login-container">
        <div class="auth-header">
            <h2>Welcome Back</h2>
            <p>Sign in to continue to Chat & Share</p>
        </div>
        <form class="auth-form" id="login-form">
            <div class="form-group">
                <label for="login-email">Email</label>
                <input type="email" id="login-email" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="login-password">Password</label>
                <input type="password" id="login-password" placeholder="Enter your password" required>
            </div>
            <button type="submit">Sign In</button>
        </form>
        <div class="auth-switch">
            Don't have an account? <a id="show-register">Sign Up</a>
        </div>
    </div>

    <!-- Register Screen -->
    <div class="auth-container hidden" id="register-container">
        <div class="auth-header">
            <h2>Create Account</h2>
            <p>Sign up to join Chat & Share</p>
        </div>
        <form class="auth-form" id="register-form">
            <div class="form-group">
                <label for="register-username">Username</label>
                <input type="text" id="register-username" placeholder="Choose a username" required>
            </div>
            <div class="form-group">
                <label for="register-email">Email</label>
                <input type="email" id="register-email" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="register-password">Password</label>
                <input type="password" id="register-password" placeholder="Create a password" required>
            </div>
            <div class="form-group">
                <label for="register-confirm">Confirm Password</label>
                <input type="password" id="register-confirm" placeholder="Confirm your password" required>
            </div>
            <button type="submit">Sign Up</button>
        </form>
        <div class="auth-switch">
            Already have an account? <a id="show-login">Sign In</a>
        </div>
    </div>

    <!-- Main App (initially hidden) -->
    <div class="container" id="app-container">
        <header>
            <h1><i class="fas fa-comment-dots"></i> Chat & Share</h1>
            <p>Real-time messaging and location sharing</p>
        </header>
        
        <div class="main-content">
            <aside class="sidebar">
                <div class="user-profile">
                    <div class="avatar" id="user-avatar">U</div>
                    <div class="user-info">
                        <div class="username" id="user-name">User123</div>
                        <div class="status">Online</div>
                    </div>
                </div>
                
                <div class="nav-items">
                    <a href="#" class="nav-item active">
                        <i class="fas fa-comment"></i> General Chat
                    </a>
                    <a href="#" class="nav-item">
                        <i class="fas fa-user-friends"></i> Friends
                    </a>
                    <a href="#" class="nav-item">
                        <i class="fas fa-map-marker-alt"></i> Location Sharing
                    </a>
                    <a href="#" class="nav-item">
                        <i class="fas fa-users"></i> Groups
                    </a>
                    <a href="#" class="nav-item">
                        <i class="fas fa-cog"></i> Settings
                    </a>
                    <a href="#" class="nav-item" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </aside>
            
            <main class="chat-container">
                <div class="chat-header">
                    <div class="chat-title">General Chat</div>
                    <div class="online-users">
                        <span class="online-count"><i class="fas fa-users"></i> 4 online</span>
                        <div class="chat-actions">
                            <button><i class="fas fa-video"></i> Start Call</button>
                        </div>
                    </div>
                </div>
                
                <div class="messages" id="messages">
                    <!-- Messages will be added here dynamically -->
                </div>
                
                <div class="input-area">
                    <input type="text" class="message-input" placeholder="Type a message..." id="message-input">
                    <button class="emoji-trigger" id="emoji-trigger">😊</button>
                    <div class="emoji-picker" id="emoji-picker">
                        <!-- Emojis will be added here dynamically -->
                    </div>
                    <button class="action-button location-button" id="location-button"><i class="fas fa-location-arrow"></i></button>
                    <button class="action-button send-button" id="send-button"><i class="fas fa-paper-plane"></i></button>
                </div>
            </main>
        </div>
        
        <footer>
            <p>&copy; 2023 Chat & Share App | Live location sharing enabled</p>
        </footer>
    </div>

    <!-- Leaflet JS for maps -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ===== APPLICATION STATE =====
        const state = {
            currentUser: null,
            users: [],
            messages: [],
            onlineUsers: 4,
            emojis: ['😀', '😂', '😍', '🥰', '😎', '🙄', '😮', '😢', '😡', '🤔', '👍', '👎', '❤️', '🔥', '🎉', '🤩', '😜', '🙏', '💯', '✨']
        };

        // ===== DOM ELEMENTS =====
        const loginContainer = document.getElementById('login-container');
        const registerContainer = document.getElementById('register-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterBtn = document.getElementById('show-register');
        const showLoginBtn = document.getElementById('show-login');
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const locationButton = document.getElementById('location-button');
        const emojiTrigger = document.getElementById('emoji-trigger');
        const emojiPicker = document.getElementById('emoji-picker');
        const logoutBtn = document.getElementById('logout-btn');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                state.currentUser = JSON.parse(savedUser);
                showApp();
            } else {
                showLogin();
            }
            
            // Initialize emoji picker
            initEmojiPicker();
            
            // Set up event listeners
            setupEventListeners();
            
            // Load sample messages
            loadSampleMessages();
            
            // Simulate receiving messages
            simulateIncomingMessages();
        });

        // ===== AUTH FUNCTIONS =====
        function showLogin() {
            loginContainer.classList.remove('hidden');
            registerContainer.classList.add('hidden');
            appContainer.style.display = 'none';
        }

        function showRegister() {
            loginContainer.classList.add('hidden');
            registerContainer.classList.remove('hidden');
            appContainer.style.display = 'none';
        }

        function showApp() {
            loginContainer.classList.add('hidden');
            registerContainer.classList.add('hidden');
            appContainer.style.display = 'flex';
            
            // Update user info
            if (state.currentUser) {
                userAvatar.textContent = state.currentUser.username.charAt(0).toUpperCase();
                userName.textContent = state.currentUser.username;
            }
        }

        function loginUser(email, password) {
            // In a real app, this would be an API call to the backend
            // For demo purposes, we'll simulate a successful login
            const user = {
                id: 1,
                username: 'DemoUser',
                email: email
            };
            
            state.currentUser = user;
            localStorage.setItem('currentUser', JSON.stringify(user));
            showApp();
            
            // Show welcome message
            addSystemMessage('Welcome to Chat & Share! Start chatting with other users.');
        }

        function registerUser(username, email, password) {
            // In a real app, this would be an API call to the backend
            // For demo purposes, we'll simulate a successful registration
            const user = {
                id: Date.now(),
                username: username,
                email: email
            };
            
            state.currentUser = user;
            localStorage.setItem('currentUser', JSON.stringify(user));
            showApp();
            
            // Show welcome message
            addSystemMessage('Welcome to Chat & Share! Start chatting with other users.');
        }

        function logoutUser() {
            state.currentUser = null;
            localStorage.removeItem('currentUser');
            showLogin();
        }

        // ===== EMOJI FUNCTIONS =====
        function initEmojiPicker() {
            // Clear existing emojis
            emojiPicker.innerHTML = '';
            
            // Add emojis to the picker
            state.emojis.forEach(emoji => {
                const emojiBtn = document.createElement('button');
                emojiBtn.classList.add('emoji-btn');
                emojiBtn.textContent = emoji;
                emojiBtn.addEventListener('click', () => {
                    messageInput.value += emoji;
                    messageInput.focus();
                });
                emojiPicker.appendChild(emojiBtn);
            });
        }

        // ===== MESSAGE FUNCTIONS =====
        function addMessage(sender, text, time, type = 'text', locationData = null) {
            const message = {
                id: Date.now(),
                sender,
                text,
                time,
                type,
                locationData
            };
            
            state.messages.push(message);
            renderMessage(message);
            
            // Save to localStorage in a real app, this would be sent to the server
            saveMessages();
        }

        function addSystemMessage(text) {
            const message = {
                id: Date.now(),
                sender: 'System',
                text,
                time: getCurrentTime(),
                type: 'system'
            };
            
            state.messages.push(message);
            renderMessage(message);
        }

        function renderMessage(message) {
            let messageElement;
            
            if (message.type === 'system') {
                messageElement = document.createElement('div');
                messageElement.className = 'message incoming system';
                messageElement.innerHTML = `
                    <div class="message-text" style="text-align: center; font-style: italic;">${message.text}</div>
                    <div class="message-time">${message.time}</div>
                `;
            } else if (message.type === 'location') {
                messageElement = document.createElement('div');
                messageElement.className = 'location-message';
                messageElement.innerHTML = `
                    <div class="location-title"><i class="fas fa-map-marker-alt"></i> ${message.sender} shared location</div>
                    <div class="map-preview" id="map-${message.id}"></div>
                    <div class="location-actions">
                        <button>View Larger</button>
                        <button>Navigate</button>
                    </div>
                    <div class="message-time">${message.time}</div>
                `;
                
                // Render the map after the element is added to the DOM
                setTimeout(() => {
                    const mapContainer = document.getElementById(`map-${message.id}`);
                    if (mapContainer) {
                        initMap(mapContainer, message.locationData.lat, message.locationData.lng, `${message.sender}'s Location`);
                    }
                }, 100);
            } else {
                const isOutgoing = message.sender === state.currentUser.username;
                messageElement = document.createElement('div');
                messageElement.className = `message ${isOutgoing ? 'outgoing' : 'incoming'}`;
                messageElement.innerHTML = `
                    <div class="message-sender">${message.sender}</div>
                    <div class="message-text">${message.text}</div>
                    <div class="message-time">${message.time}</div>
                `;
            }
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function loadSampleMessages() {
            const savedMessages = localStorage.getItem('chatMessages');
            if (savedMessages) {
                state.messages = JSON.parse(savedMessages);
                state.messages.forEach(message => renderMessage(message));
            } else {
                // Load sample messages if none exist
                const sampleMessages = [
                    {
                        sender: 'Alice',
                        text: 'Hey everyone! How\'s it going?',
                        time: '10:05 AM',
                        type: 'text'
                    },
                    {
                        sender: 'You',
                        text: 'Pretty good! Just working on this new chat app 😊',
                        time: '10:07 AM',
                        type: 'text'
                    },
                    {
                        sender: 'Bob',
                        text: 'That\'s cool! Can we share locations with this?',
                        time: '10:09 AM',
                        type: 'text'
                    },
                    {
                        sender: 'Alice',
                        text: '',
                        time: '10:10 AM',
                        type: 'location',
                        locationData: { lat: 37.7749, lng: -122.4194 }
                    },
                    {
                        sender: 'Charlie',
                        text: 'Wow, that\'s a nice feature! I\'ll share mine too',
                        time: '10:12 AM',
                        type: 'text'
                    }
                ];
                
                state.messages = sampleMessages;
                sampleMessages.forEach(message => renderMessage(message));
                saveMessages();
            }
        }

        function saveMessages() {
            localStorage.setItem('chatMessages', JSON.stringify(state.messages));
        }

        function getCurrentTime() {
            const now = new Date();
            return now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes();
        }

        // ===== MAP FUNCTIONS =====
        function initMap(containerElement, lat, lng, title) {
            const map = L.map(containerElement).setView([lat, lng], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            L.marker([lat, lng]).addTo(map)
                .bindPopup(title)
                .openPopup();
                
            return map;
        }

        // ===== EVENT HANDLERS =====
        function setupEventListeners() {
            // Auth form submissions
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                loginUser(email, password);
            });
            
            registerForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('register-username').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirm = document.getElementById('register-confirm').value;
                
                if (password !== confirm) {
                    alert('Passwords do not match!');
                    return;
                }
                
                registerUser(username, email, password);
            });
            
            // Auth screen switches
            showRegisterBtn.addEventListener('click', showRegister);
            showLoginBtn.addEventListener('click', showLogin);
            
            // Chat functionality
            sendButton.addEventListener('click', handleSendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSendMessage();
                }
            });
            
            // Location sharing
            locationButton.addEventListener('click', handleShareLocation);
            
            // Emoji picker
            emojiTrigger.addEventListener('click', () => {
                emojiPicker.classList.toggle('active');
            });
            
            // Close emoji picker when clicking outside
            document.addEventListener('click', (e) => {
                if (!emojiPicker.contains(e.target) && e.target !== emojiTrigger) {
                    emojiPicker.classList.remove('active');
                }
            });
            
            // Logout
            logoutBtn.addEventListener('click', logoutUser);
        }

        function handleSendMessage() {
            const messageText = messageInput.value.trim();
            if (messageText && state.currentUser) {
                addMessage(state.currentUser.username, messageText, getCurrentTime());
                messageInput.value = '';
                
                // Simulate a reply after a short delay
                setTimeout(simulateReply, 1000);
            }
        }

        function handleShareLocation() {
            if (!state.currentUser) return;
            
            // In a real app, this would get the user's actual location
            // For demo purposes, we're using a random location near the user
            const randomOffset = () => (Math.random() - 0.5) * 0.02;
            const userLat = 37.7749 + randomOffset();
            const userLng = -122.4194 + randomOffset();
            
            addMessage(state.currentUser.username, '', getCurrentTime(), 'location', {
                lat: userLat,
                lng: userLng
            });
            
            // Simulate location sharing responses
            setTimeout(() => {
                addMessage('Bob', 'Thanks for sharing your location!', getCurrentTime());
            }, 1500);
            
            setTimeout(() => {
                addMessage('Charlie', 'I can see where you are. I\'m not far away!', getCurrentTime());
            }, 3000);
        }

        // ===== SIMULATION FUNCTIONS =====
        function simulateIncomingMessages() {
            // Simulate occasional incoming messages
            setInterval(() => {
                if (state.currentUser && Math.random() < 0.2) { // 20% chance every 10 seconds
                    simulateReply();
                }
            }, 10000);
        }

        function simulateReply() {
            const senders = ['Alice', 'Bob', 'Charlie'];
            const replies = [
                "That's interesting!",
                "I see what you mean",
                "Let me think about that",
                "I agree with you",
                "We should discuss this more",
                "What do others think?",
                "I'm not sure about that",
                "That makes sense",
                "Thanks for sharing!",
                "I'll check that out"
            ];
            
            const randomSender = senders[Math.floor(Math.random() * senders.length)];
            const randomReply = replies[Math.floor(Math.random() * replies.length)];
            
            addMessage(randomSender, randomReply, getCurrentTime());
        }
    </script>
</body>
</html>
